name: Sync upstream repository

on:
  schedule:
    - cron: '0 2 * * *'  # каждый день в 2:00
  workflow_dispatch:

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout corporate repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/rosetta-models/blank-base-model.git || true
          git fetch upstream master

      - name: Checkout feature/upstream-updates branch
        run: git checkout feature/upstream-updates

      - name: Determine new commits
        id: new_commits
        run: |
          COMMITS=$(comm -23 <(git rev-list upstream/main | sort) <(git rev-list feature/upstream-updates | sort) | tr '\n' ' ')
          echo "new_commits=$COMMITS" >> $GITHUB_ENV
          echo "Found $(echo "$COMMITS" | wc -w) new commits"


      - name: Cherry-pick new commits
        if: env.new_commits != ''
        run: |
          for c in ${{ env.new_commits }}; do
            echo "Applying commit $c"
            git cherry-pick $c || git cherry-pick --skip
          done

      - name: Push changes
        if: env.new_commits != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push https://x-access-token:${GH_TOKEN}@github.com/<org>/company-blank-base-model.git feature/upstream-updates


---

- name: Add upstream remote
  run: |
    if [ "${{ inputs.use_token }}" = "true" ]; then
      TOKEN=${{ secrets[${{ inputs.secret_name }}] }}
      git remote add upstream https://x-access-token:$TOKEN@github.com/rosetta-models/blank-base-model.git || true
    else
      git remote add upstream https://github.com/rosetta-models/blank-base-model.git || true
    fi
    git fetch upstream master

if [ "${{ inputs.use_token }}" = "true" ]; then
  TOKEN=${{ secrets[inputs.secret_name] }}
  git remote add upstream "https://x-access-token:$TOKEN@github.com/org/repo.git"
else
  git remote add upstream "https://github.com/org/repo.git"
fi
