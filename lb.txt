name: Sync upstream repository

on:
  schedule:
    - cron: '0 2 * * *'  # каждый день в 2:00
  workflow_dispatch:

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout corporate repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/rosetta-models/blank-base-model.git || true
          git fetch upstream master

      - name: Checkout feature/upstream-updates branch
        run: git checkout feature/upstream-updates

      - name: Determine new commits
        id: new_commits
        run: |
          # Список коммитов upstream/master, которых нет в нашей ветке
          COMMITS=$(comm -23 <(git rev-list upstream/master | sort) <(git rev-list feature/upstream-updates | sort))
          echo "new_commits=$COMMITS" >> $GITHUB_ENV
          echo "Found $(echo "$COMMITS" | wc -w) new commits"

      - name: Cherry-pick new commits
        if: env.new_commits != ''
        run: |
          for c in ${{ env.new_commits }}; do
            echo "Applying commit $c"
            git cherry-pick $c || git cherry-pick --skip
          done

      - name: Push changes
        if: env.new_commits != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push https://x-access-token:${GH_TOKEN}@github.com/<org>/company-blank-base-model.git feature/upstream-updates
